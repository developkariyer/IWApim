{# ozon.html.twig #}
{% extends 'ozon/base.html.twig' %}
{% block title %}Ozon Listing{% endblock %}
{% block content %}
    <div class="accordion" id="ozonAccordion">
        <!-- Level 0: ListingTemplate Objects -->
        {% for task in tasks %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingTask{{ task.id }}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTask{{ task.id }}" aria-expanded="false" aria-controls="collapseTask{{ task.id }}">
                        Ozon Listing: {{ task.key }}
                    </button>
                </h2>
                <div id="collapseTask{{ task.id }}" class="accordion-collapse collapse" aria-labelledby="headingTask{{ task.id }}" data-bs-parent="#ozonAccordion">
                    <div class="accordion-body">
                        <div id="parentProductAccordion{{ task.id }}">
                            <!-- Parent Products will be loaded dynamically -->
                        </div>

                        <!-- Add Parent Product Form -->
                        <form method="POST" action="/ozon/addproduct/{{ task.id }}" class="mt-3">
                            <div class="input-group mb-3 mt-3">
                                <input type="text" class="form-control" name="iwasku" placeholder="Eklenecek IWASKU" aria-label="Eklenecek IWASKU">
                                <button class="btn btn-primary" type="submit">Ekle</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        {% endfor %}

        <!-- New Task Form as an Accordion Item -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingNewTask">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseNewTask" aria-expanded="false" aria-controls="collapseNewTask">
                    Add New Task
                </button>
            </h2>
            <div id="collapseNewTask" class="accordion-collapse collapse" aria-labelledby="headingNewTask" data-bs-parent="#ozonAccordion">
                <div class="accordion-body">
                    {{ form_start(newTaskForm, {'attr': {'class': 'mt-3'}}) }}
                    {{ form_row(newTaskForm.marketplace) }}
                    {{ form_row(newTaskForm.taskName) }}
                    {{ form_row(newTaskForm.save) }}
                    {{ form_end(newTaskForm) }}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block body_scripts %}
    <script>
        $(document).ready(function () {
            // Load Parent Products dynamically when accordion is expanded
            $(document).on('show.bs.collapse', '.accordion-collapse', function () {
                const taskId = $(this).attr('id').replace('collapseTask', '');
                const parentAccordion = $(`#parentProductAccordion${taskId}`);

                // Check if parent products are already loaded
                if (!parentAccordion.data('loaded')) {
                    // Load parent products via AJAX
                    $.get(`/ozon/${taskId}`, function (data) {
                        parentAccordion.html(data);
                        parentAccordion.data('loaded', true); // Mark as loaded
                    });
                }
            });

            // Load Child Products dynamically
            $(document).on('click', '.load-child-products', function () {
                const taskId = $(this).data('task-id');
                const parentProductId = $(this).data('parent-product-id');
                const childAccordion = $(`#childProductAccordion${parentProductId}`);

                // Load child products via AJAX
                $.get(`/ozon/${taskId}/${parentProductId}`, function (data) {
                    childAccordion.html(data);
                });
            });
        });
    </script>
{% endblock %}
